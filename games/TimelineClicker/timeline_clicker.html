
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Clicker: Echoes of Eternity üï∞Ô∏è</title>
    <style>
        :root {
            --primary-bg: #1f2833; 
            --secondary-bg: #2c3e50; 
            --tertiary-bg: #1a222a; 
            --text-color: #c5c6c7; 
            --accent-color: #66fcf1; 
            --accent-hover-color: #45a29e; 
            --success-color: #4caf50; 
            --error-color: #f44336;
            --info-color: #2196f3;
            --knowledge-color: var(--info-color);
            --influence-color: #ff9800; 
            --development-progress-color: var(--success-color);
            --temporal-shard-color: #9c27b0;
            --border-radius: 8px;
            --box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            --text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            user-select: none;
            overflow-y: auto;
        }
        #game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1300px; 
        }
        #game-title {
            font-size: 2.8em; 
            color: var(--accent-color);
            margin-bottom: 25px;
            text-shadow: 3px 3px 5px rgba(0,0,0,0.6);
            letter-spacing: 1px;
            font-weight: 300;
        }
        #global-event-display {
            background-color: var(--accent-color);
            color: var(--primary-bg);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-weight: bold;
            box-shadow: var(--box-shadow);
            display: none; 
        }
        #main-tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: var(--tertiary-bg);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .tab-button {
            padding: 12px 25px; 
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            font-size: 1.1em; 
            border-radius: var(--border-radius);
            transition: background-color 0.3s, color 0.3s, transform 0.1s;
            margin: 0 5px;
        }
        .tab-button.active, .tab-button:hover {
            background-color: var(--accent-color);
            color: var(--primary-bg);
            transform: translateY(-2px);
        }
        .tab-content { display: none; animation: fadeIn 0.5s ease-out; }
        .tab-content.active { display: block; width: 100%;}
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #game-container {
            display: grid;
            grid-template-columns: 1fr 2.2fr 1fr; 
            grid-template-areas:
                "stats current-development advancements"
                "breakthroughs current-development societal-shifts" 
                "messages messages messages"
                "controls controls controls";
            gap: 25px; 
            background-color: var(--secondary-bg);
            padding: 25px; 
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
        }
        .game-area {
            background-color: var(--tertiary-bg); 
            padding: 20px; 
            border-radius: var(--border-radius);
            border: 1px solid rgba(102,252,241,0.08); 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        #stats-area { grid-area: stats; }
        #stats-area p { margin: 10px 0; font-size: 1em; } 
        #stats-area span { font-weight: bold; color: var(--accent-color); }
        #era-progress-bar-container {
            width: 100%; height: 12px; background-color: #444; border-radius: 6px; margin-top: 5px; overflow: hidden;
        }
        #era-progress-bar { height: 100%; background-color: var(--accent-color); width: 0%; transition: width 0.2s; }


        #current-development-area { /* Renamed from epoch-area */
            grid-area: current-development; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: rgba(0,0,0,0.15); 
        }
        #current-development-display { /* Renamed from current-epoch-display */
            width: 250px; height: 250px; 
            color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 20px; 
            cursor: pointer; text-align: center;
            border: 4px solid; 
            transition: transform 0.05s cubic-bezier(0.22, 1, 0.36, 1), background-color 0.3s, border-color 0.3s, box-shadow 0.1s;
            box-shadow: 0 0 15px rgba(0,0,0,0.4) inset, 0 0 5px var(--accent-color); 
            position: relative;
            font-size: 1.1em; 
        }
        #current-development-display.major-milestone { animation: majorTurningPointPulse 1.5s infinite; } /* For special developments */
        @keyframes majorTurningPointPulse { 0%, 100% { box-shadow: 0 0 15px var(--temporal-shard-color), 0 0 25px var(--temporal-shard-color) inset; } 50% { box-shadow: 0 0 25px var(--temporal-shard-color), 0 0 40px var(--temporal-shard-color) inset; } }
        #current-development-display:active { transform: scale(0.92); box-shadow: 0 0 10px rgba(0,0,0,0.2) inset; }
        #development-name { font-weight: bold; font-size: 1.4em; margin-bottom: 8px; text-shadow: var(--text-shadow); }
        #development-description { font-size: 0.9em; margin-bottom: 10px; opacity: 0.8; max-width: 90%;}
        #development-progress-text { font-size: 0.95em; }
        #development-progress-bar-container {
            width: 90%; height: 30px; background-color: rgba(0,0,0,0.4); border-radius: 8px; margin-top: 12px; overflow: hidden; border: 1px solid rgba(0,0,0,0.6);
        }
        #development-progress-bar { height: 100%; background-color: var(--development-progress-color); width: 100%; transition: width 0.1s linear; }
        
        #progress-feedback-container, #resource-feedback-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .feedback-number {
            position: absolute; font-weight: bold; opacity: 1;
            animation: floatUpStrong 0.8s ease-out forwards;
            text-shadow: 1px 1px 1px black;
        }
        .progress-number { font-size: 1.7em; color: var(--accent-color); } 
        .breakthrough-feedback { color: #ffeb3b !important; font-size: 2.2em !important; animation: floatUpCrit 0.9s ease-out forwards !important; }
        .knowledge-feedback { font-size: 1.3em; color: var(--knowledge-color); }
        .influence-feedback { font-size: 1.3em; color: var(--influence-color); }

        @keyframes floatUpStrong {
            to { transform: translateY(-70px) scale(0.8); opacity: 0; }
        }
        @keyframes floatUpCrit {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-40px) scale(1.3); opacity: 0.8; }
            100% { transform: translateY(-80px) scale(0.7); opacity: 0; }
        }
        #era-flavor-text { margin-top: 15px; font-size: 1.1em; color: var(--text-color); font-style: italic; text-align: center;}


        #advancements-area { grid-area: advancements; }
        #societal-shifts-area { grid-area: societal-shifts; } 
        #breakthroughs-area { grid-area: breakthroughs; }
        
        .area-title { font-size: 1.6em; margin-bottom: 15px; color: var(--accent-color); text-align: center; text-shadow: var(--text-shadow); }
        
        .advancement-button, .breakthrough-button, #epoch-shift-button, .milestone button, .paradigm-button { 
            display: block; margin-bottom: 12px; padding: 14px; width: 100%; box-sizing: border-box;
            background-image: linear-gradient(to bottom, var(--accent-color), var(--accent-hover-color));
            color: var(--primary-bg); border: none;
            border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease-in-out;
            font-size: 1em; position: relative; overflow: hidden;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }
        .advancement-button:hover, .breakthrough-button:hover, #epoch-shift-button:hover, .paradigm-button:hover {
            background-image: linear-gradient(to bottom, var(--accent-hover-color), var(--accent-color));
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }
        .advancement-button:active, .breakthrough-button:active, #epoch-shift-button:active, .paradigm-button:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .advancement-button small, .breakthrough-button small, .paradigm-button small { display: block; font-size: 0.85em; opacity: 0.9; margin-top: 3px; }
        .cooldown-bar {
            position: absolute; bottom: 0; left: 0; height: 6px; background-color: rgba(var(--success-color), 0.6); 
            width: 0%; transition: width 0.1s linear; border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        button:disabled {
            background-image: linear-gradient(to bottom, #546e7a, #78909c) !important; 
            color: #bdbdbd !important;
            cursor: not-allowed !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
            transform: translateY(0) !important;
        }

        #milestones-container, #epoch-shift-upgrades-container, #paradigms-list { 
            max-height: 450px; overflow-y: auto; padding-right: 10px;
        }
        .milestone {
            background-color: rgba(0,0,0,0.25); padding: 12px; border-radius: var(--border-radius);
            margin-bottom: 10px; border-left: 6px solid var(--tertiary-bg); transition: border-color 0.3s;
        }
        .milestone.completed { border-left-color: var(--success-color); background-color: rgba(76, 175, 80, 0.1); }
        .milestone h4 { margin: 0 0 6px 0; color: var(--accent-color); font-size: 1.05em; }
        .milestone p { margin: 0 0 4px 0; font-size: 0.9em; }
        .milestone button { font-size: 0.85em; padding: 6px 12px; float: right; background-image: linear-gradient(to bottom, var(--info-color), #1976d2); }
        .milestone button:hover { background-image: linear-gradient(to bottom, #1976d2, var(--info-color)); }
        .milestone button:disabled { background-image: linear-gradient(to bottom, #7f8c8d, #95a5a6) !important; }


        #messages-area { 
            grid-area: messages; min-height: 45px; 
            font-weight: bold; text-align: center; display: flex; align-items: center; justify-content: center;
            font-size: 1.15em; border-radius: var(--border-radius); background-color: var(--tertiary-bg);
            text-shadow: var(--text-shadow);
        }
        #controls-area { grid-area: controls; text-align: center; }
        #controls-area button { 
            margin: 8px; padding: 12px 25px; background-color: #455a64; color: var(--text-color); 
            border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s, transform 0.1s;
            font-size: 1em;
        }
        #controls-area button:hover { background-color: #607d8b; transform: translateY(-1px); }
        #controls-area button:active { transform: translateY(1px); }
        
        #daily-reward-popup, #offline-progress-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background-color: var(--secondary-bg); padding: 35px; border-radius: var(--border-radius);
            box-shadow: var(--box-shadow); text-align: center; z-index: 1001;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); border: 3px solid var(--accent-color);
            width: 90%; max-width: 450px;
        }
        #daily-reward-popup.visible, #offline-progress-popup.visible { transform: translate(-50%, -50%) scale(1); }
        #daily-reward-popup h3, #offline-progress-popup h3 { color: var(--accent-color); margin-top: 0; font-size: 1.8em; }
        #daily-reward-popup p, #offline-progress-popup p { font-size: 1.1em; margin-bottom: 15px; }
        #daily-reward-popup button, #offline-progress-popup button { margin-top: 20px; font-size: 1.1em; padding: 12px 25px; }
        
        .screen-flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(102, 252, 241, 0.7); 
            opacity: 0; pointer-events: none; z-index: 2000;
            animation: flashAnimation 0.5s ease-out;
        }
        @keyframes flashAnimation {
            0% { opacity: 0.7; }
            100% { opacity: 0; }
        }
        .screen-shake { animation: shakeAnimation 0.3s linear; }
        @keyframes shakeAnimation {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-0.5deg); }
            50% { transform: translateX(5px) rotate(0.5deg); }
            75% { transform: translateX(-3px) rotate(-0.3deg); }
        }
        .breakthrough-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 30px 15px var(--knowledge-color);
            opacity: 0; pointer-events: none; z-index: 1999;
            animation: breakthroughGlowAnim 0.6s ease-out;
        }
         @keyframes breakthroughGlowAnim {
            0% { opacity: 0.6; }
            100% { opacity: 0; }
        }

        @media (max-width: 1100px) { 
            #game-container {
                grid-template-columns: 1fr 1fr;
                grid-template-areas:
                    "current-development current-development"
                    "stats advancements"
                    "breakthroughs societal-shifts"
                    "messages messages"
                    "controls controls";
            }
            #current-development-display { width: 220px; height: 220px;} 
        }
        @media (max-width: 700px) { 
            body { padding: 10px; }
            #game-wrapper { max-width: 100%; }
            #game-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "current-development"
                    "stats"
                    "advancements"
                    "breakthroughs"
                    "societal-shifts"
                    "messages"
                    "controls";
                gap: 15px; 
                padding: 15px;
            }
            .game-area { padding: 15px; }
            #current-development-display { width: 200px; height: 200px;}
            .tab-button { padding: 10px 15px; font-size: 1em;}
            #game-title { font-size: 2.0em; }
        }

    </style>
</head>
<body>
    <div id="game-wrapper">
        <h1 id="game-title">Timeline Clicker: Echoes of Eternity üï∞Ô∏è</h1>
        <div id="global-event-display">üìú Age of Enlightenment Active! +50% Knowledge! üìú</div>

        <div id="main-tabs">
            <button class="tab-button active" onclick="openTab('gameTab')">‚è≥ Timeline</button>
            <button class="tab-button" onclick="openTab('paradigmsTab')">üåå Paradigms</button>
            <button class="tab-button" onclick="openTab('milestonesTab')">üèÜ Milestones (<span id="milestones-count">0</span>)</button>
            <button class="tab-button" onclick="openTab('epochShiftTab')" id="epoch-shift-tab-button" style="display:none;">üåÄ Epoch Shift</button>
        </div>

        <div id="gameTab" class="tab-content active">
            <div id="game-container">
                <div id="stats-area" class="game-area">
                    <h2 class="area-title">üìä Civilization Stats</h2>
                    <p>üï∞Ô∏è Current Era: <span id="current-era-name">The Void</span></p>
                    <p>üõ†Ô∏è Era Progress: <span id="era-developments-completed">0</span> / <span id="era-developments-total">0</span></p>
                    <div id="era-progress-bar-container"><div id="era-progress-bar"></div></div>
                    <p>üí° Knowledge: <span id="knowledge">0</span></p>
                    <p>üåç Influence: <span id="influence">0</span></p>
                    <p>üñ±Ô∏è Progress/Click: <span id="progress-per-click">1</span></p>
                    <p>üí° Knowledge/Click: <span id="knowledge-per-click">0</span></p>
                    <p>üìà Societal Momentum: <span id="passive-progress-rate">0</span> P/s</p>
                    <p>‚ú® Breakthrough Chance: <span id="breakthrough-chance">2</span>%</p>
                    <p>üí• Breakthrough Impact: +<span id="breakthrough-impact-bonus">50</span>%</p>
                    <p>‚úîÔ∏è Eras Completed this Shift: <span id="eras-completed-this-shift">0</span></p>
                    <hr style="border-color: rgba(102,252,241,0.1); margin: 10px 0;">
                    <p><strong>Global Modifiers (from Epoch Shifts):</strong></p>
                    <p>üí° Knowledge Bonus: +<span id="global-knowledge-bonus-display">0</span>%</p>
                    <p>üåç Influence Bonus: +<span id="global-influence-bonus-display">0</span>%</p>
                    <p>üìà Progress Bonus: +<span id="global-progress-bonus-display">0</span>%</p>
                    <p>üåÄ Temporal Shards: <span id="current-temporal-shards-display">0</span></p>
                </div>

                <div id="current-development-area" class="game-area">
                    <div id="current-development-display" style="background-color: #333; border-color: #555;">
                        <p id="development-name">Initial Spark</p>
                        <p id="development-description">The very first stirring of potential...</p>
                        <p id="development-progress-text">‚öôÔ∏è Progress: <span id="development-current-progress">0</span> / <span id="development-max-progress">10</span></p>
                        <div id="development-progress-bar-container">
                            <div id="development-progress-bar" style="width: 0%;"></div>
                        </div>
                        <div id="progress-feedback-container"></div>
                        <div id="resource-feedback-container"></div>
                    </div>
                    <p id="era-flavor-text">The mists of time swirl, awaiting a guiding hand...</p>
                </div>

                <div id="advancements-area" class="game-area">
                    <h2 class="area-title">üõ†Ô∏è Core Advancements</h2>
                    <button id="adv-progress-per-click" class="advancement-button">üñ±Ô∏è Enhance Focus (Progress/Click)</button>
                    <button id="adv-knowledge-per-click" class="advancement-button">üí° Refine Observation (Knowledge/Click)</button>
                    <button id="adv-passive-progress" class="advancement-button">üìà Improve Organization (Societal Momentum)</button>
                    <button id="adv-breakthrough-chance" class="advancement-button">‚ú® Foster Innovation (Breakthrough Chance)</button>
                    <button id="adv-breakthrough-impact" class="advancement-button">üí• Amplify Discoveries (Breakthrough Impact)</button>
                </div>

                <div id="breakthroughs-area" class="game-area">
                    <h2 class="area-title">‚ö° Breakthroughs</h2>
                    <button id="breakthrough-inspiredThought" class="breakthrough-button" disabled>
                        üí° Inspired Thought
                        <small>Massive progress burst! (CD: <span id="it-cooldown-display">30</span>s)</small>
                        <div class="cooldown-bar" id="it-cooldown-bar"></div>
                    </button>
                    <button id="breakthrough-goldenAge" class="breakthrough-button" disabled>
                        üåü Golden Age
                        <small>Boosts all resource gain! (CD: <span id="ga-cooldown-display">60</span>s)</small>
                        <div class="cooldown-bar" id="ga-cooldown-bar"></div>
                    </button>
                     <button id="breakthrough-rapidDevelopment" class="breakthrough-button" disabled>
                        üöÄ Rapid Development
                        <small>Greatly speeds up current development! (CD: <span id="rd-cooldown-display">90</span>s)</small>
                        <div class="cooldown-bar" id="rd-cooldown-bar"></div>
                    </button>
                </div>
                
                <div id="societal-shifts-area" class="game-area"> 
                     <h2 class="area-title">üèõÔ∏è Societal Shifts</h2>
                     <button id="shift-knowledge-affinity" class="advancement-button" style="display:none;">üí° Knowledge Affinity</button>
                     <button id="shift-influence-spread" class="advancement-button" style="display:none;">üåç Cultural Exchange</button>
                </div>

                <div id="messages-area" class="game-area">üåå Click the swirling mists of time to begin...</div>
                
                <div id="controls-area" class="game-area">
                    <button id="save-game">üíæ Save Chronicle</button>
                    <button id="load-game">üìÇ Load Chronicle</button>
                    <button id="reset-game">üîÑ Shatter Timeline</button>
                </div>
            </div>
        </div>
        
        <div id="paradigmsTab" class="tab-content">
            <div class="game-area">
                <h2 class="area-title">üåå Paradigm Shifts</h2>
                <div id="paradigms-list">
                </div>
            </div>
        </div>

        <div id="milestonesTab" class="tab-content">
            <div class="game-area">
                <h2 class="area-title">üèÜ Milestones (<span id="milestones-completed-count">0</span>/<span id="milestones-total-count">0</span>)</h2>
                <div id="milestones-container"></div>
            </div>
        </div>

        <div id="epochShiftTab" class="tab-content">
            <div class="game-area">
                <h2 class="area-title">üåÄ Epoch Shift Chamber</h2>
                <p>Reach Era: "<span id="epoch-shift-required-era-name-display">Classical Age</span>" to perform an Epoch Shift.</p>
                <p>Shifting resets current Era, Developments, Knowledge, Influence, Core Advancements, and Societal Shifts.</p>
                <p>You will earn <span id="temporal-shards-to-gain">0</span> Temporal Shards (üåÄ).</p>
                <p>Current Temporal Shards (üåÄ): <span id="current-temporal-shards">0</span></p>
                <button id="epoch-shift-button" class="advancement-button" disabled>üåÄ Shift Epoch!</button>
                <hr style="margin: 20px 0; border-color: rgba(102,252,241,0.1);">
                <h3 class="area-title">‚ú® Temporal Upgrades</h3>
                <div id="epoch-shift-upgrades-container">
                    <button class="advancement-button" id="eshift-global-knowledge">üí° Global Knowledge Bonus</button>
                    <button class="advancement-button" id="eshift-global-influence">üåç Global Influence Bonus</button>
                    <button class="advancement-button" id="eshift-global-progress">üìà Global Progress Bonus</button>
                    <button class="advancement-button" id="eshift-start-knowledge">üß† Starting Knowledge</button>
                    <button class="advancement-button" id="eshift-shard-multiplier">üåÄ Shard Multiplier</button>
                </div>
            </div>
        </div>
    </div>

    <div id="daily-reward-popup">
        <h3>üéÅ Temporal Echo! üéÅ</h3>
        <p id="daily-reward-text">Claim your daily historical fragment!</p>
        <button id="claim-daily-reward" class="advancement-button">Claim ‚ú®</button>
    </div>
    <div id="offline-progress-popup">
        <h3>üïí History Unfolded... üïí</h3>
        <p id="offline-progress-text">Your civilization made progress while you were away!</p>
        <button id="claim-offline-progress" class="advancement-button">Observe Gains üìú</button>
    </div>

    <script>
        let gameState;

        const ERA_DEFINITIONS = [
            {
                id: "prehistory", name: "Prehistory",
                description: "Before written records, humanity took its first tentative steps.",
                backgroundColor: "#4a5058", borderColor: "#33373d",
                unlocksAdvancements: [], unlocksBreakthroughsAtStart: [], unlocksParadigms: [],
                isMajorTurningPointEra: false, epochShiftRequirementOrder: 0,
                developments: [
                    { id: "primordial_spark", name: "Primordial Spark ‚ú®", description: "The very first stirring of potential.", effortRequired: 20, rewards: { knowledge: 5, influence: 1 } },
                    { id: "sentience_dawn", name: "Dawn of Sentience ü§î", description: "Basic awareness begins to form.", effortRequired: 30, rewards: { knowledge: 10, influence: 2 } }
                ]
            },
            {
                id: "stone_age", name: "Stone Age",
                description: "The dawn of humanity, marked by rudimentary tools and the struggle for survival.",
                backgroundColor: "#795548", borderColor: "#5d4037",
                unlocksAdvancements: ["adv-progress-per-click", "adv-knowledge-per-click"],
                unlocksBreakthroughsAtStart: ["INSPIRED_THOUGHT"],
                unlocksParadigms: [],
                isMajorTurningPointEra: false, epochShiftRequirementOrder: 1,
                developments: [
                    { id: "crude_tools", name: "Crude Stone Tools üõ†Ô∏è", description: "Sharp-edged rocks prove useful.", effortRequired: 50, rewards: { knowledge: 20, influence: 5, tempProgressPerClickBonus: 1, tempBonusDurationTicks: 30 } },
                    { id: "controlled_fire", name: "Controlled Fire üî•", description: "Harnessing flames for warmth, cooking, and protection.", effortRequired: 80, rewards: { knowledge: 35, influence: 8, tempKnowledgePerClickBonus: 1, tempBonusDurationTicks: 30 } },
                    { id: "hunter_gatherers", name: "Hunter-Gatherer Bands üèπ", description: "Small groups cooperate to survive.", effortRequired: 120, rewards: { knowledge: 50, influence: 12 } , unlocksAdvancements: ["adv-passive-progress"]},
                    { id: "cave_art", name: "Cave Art üé®", description: "Early expressions of symbolism and storytelling.", effortRequired: 150, rewards: { knowledge: 60, influence: 15, breakthroughChanceBonus: 0.001 } }
                ]
            },
            {
                id: "neolithic_age", name: "Neolithic Age",
                description: "The agricultural revolution transforms human society.",
                backgroundColor: "#4caf50", borderColor: "#388e3c",
                unlocksAdvancements: ["adv-breakthrough-chance"],
                unlocksBreakthroughsAtStart: ["GOLDEN_AGE"],
                unlocksParadigms: [],
                isMajorTurningPointEra: false, epochShiftRequirementOrder: 2,
                developments: [
                    { id: "early_farming", name: "Early Farming üåæ", description: "Cultivating crops provides a stable food source.", effortRequired: 250, rewards: { knowledge: 100, influence: 25 } },
                    { id: "animal_domestication", name: "Animal Domestication üêë", description: "Taming animals for food, labor, and companionship.", effortRequired: 300, rewards: { knowledge: 120, influence: 30 } },
                    { id: "permanent_settlements", name: "Permanent Settlements üèòÔ∏è", description: "Villages emerge as people stay in one place.", effortRequired: 400, rewards: { knowledge: 180, influence: 40 } },
                    { id: "pottery", name: "Pottery Craftingüè∫", description: "Creating vessels for storage and cooking.", effortRequired: 350, rewards: { knowledge: 150, influence: 35 } }
                ]
            },
            {
                id: "bronze_age", name: "Bronze Age",
                description: "The discovery of bronze leads to new tools, weapons, and complex societies.",
                backgroundColor: "#e67e22", borderColor: "#d35400",
                unlocksAdvancements: ["adv-breakthrough-impact", "shift-knowledge-affinity"],
                unlocksBreakthroughsAtStart: ["RAPID_DEVELOPMENT"],
                unlocksParadigms: [],
                isMajorTurningPointEra: true, epochShiftRequirementOrder: 3, // Example of a Major Turning Point Era
                developments: [
                    { id: "bronze_smelting", name: "Bronze Smelting üî©", description: "Combining copper and tin to create a stronger metal.", effortRequired: 600, rewards: { knowledge: 250, influence: 60 } },
                    { id: "first_cities", name: "First Cities üèôÔ∏è", description: "Large, organized urban centers develop.", effortRequired: 800, rewards: { knowledge: 350, influence: 80 } },
                    { id: "writing_systems", name: "Early Writing Systems ‚úçÔ∏è", description: "Recording information through symbols.", effortRequired: 1000, rewards: { knowledge: 500, influence: 100 }, isKeyDevelopment: true },
                    { id: "trade_routes", name: "Trade Routes üó∫Ô∏è", description: "Networks for exchanging goods and ideas expand.", effortRequired: 700, rewards: { knowledge: 300, influence: 120 } }
                ]
            },
            {
                id: "iron_age", name: "Iron Age",
                description: "Iron technology spreads, forging stronger empires and tools.",
                backgroundColor: "#7f8c8d", borderColor: "#607d8b",
                unlocksAdvancements: ["shift-influence-spread"],
                unlocksBreakthroughsAtStart: [],
                unlocksParadigms: ["scientificMethod", "industrialization"], // Example unlock
                isMajorTurningPointEra: false, epochShiftRequirementOrder: 4,
                developments: [
                    { id: "iron_working", name: "Iron Working ‚öîÔ∏è", description: "Mastering the art of forging iron.", effortRequired: 1500, rewards: { knowledge: 700, influence: 150 } },
                    { id: "large_empires", name: "Rise of Large Empires üèõÔ∏è", description: "Consolidation of power into vast states.", effortRequired: 2000, rewards: { knowledge: 900, influence: 250 } },
                    { id: "coinage", name: "Coinage Introduction üí∞", description: "Standardized currency simplifies trade.", effortRequired: 1800, rewards: { knowledge: 800, influence: 200 } },
                ]
            },
             {
                id: "classical_antiquity", name: "Classical Antiquity",
                description: "A period of immense cultural, philosophical, and political achievements.",
                backgroundColor: "#3498db", borderColor: "#2980b9",
                unlocksAdvancements: [],
                unlocksBreakthroughsAtStart: [],
                unlocksParadigms: [],
                isMajorTurningPointEra: true, epochShiftRequirementOrder: 5,
                developments: [
                    { id: "philosophy_schools", name: "Schools of Philosophy ü§î", description: "Great thinkers ponder existence and ethics.", effortRequired: 3000, rewards: { knowledge: 1200, influence: 300 } },
                    { id: "democratic_ideals", name: "Democratic Ideals üó≥Ô∏è", description: "Concepts of citizen participation in governance emerge.", effortRequired: 3500, rewards: { knowledge: 1500, influence: 350 } },
                    { id: "monumental_architecture", name: "Monumental Architecture üèõÔ∏è", description: "Construction of grand temples, theaters, and public works.", effortRequired: 4000, rewards: { knowledge: 1800, influence: 400 } },
                ]
            },
            {
                id: "singularity_approaches", name: "Singularity Approaches",
                description: "The theoretical point where artificial superintelligence triggers runaway technological growth.",
                backgroundColor: "#9b59b6", borderColor: "#8e44ad",
                isMajorTurningPointEra: true, epochShiftRequirementOrder: 99, // Far future
                developments: [
                     { id: "true_ai", name: "True AI Awakening ü§ñ", description: "Artificial general intelligence is achieved.", effortRequired: 1000000, rewards: { knowledge: 500000, influence: 100000 } },
                ]
            }
        ];

        const EPOCH_SHIFT_REQUIRED_ERA_ORDER = 5; // Corresponds to "Classical Antiquity" (order 5)
        const BREAKTHROUGH_CHANCE_BASE = 0.02; 

        const BREAKTHROUGHS_TEMPLATE = {
            INSPIRED_THOUGHT: {
                id: "inspiredThought", name: "Inspired Thought", cooldown: 30, currentCooldown: 0, progressMultiplier: 5, isActive: false
            },
            GOLDEN_AGE: {
                id: "goldenAge", name: "Golden Age", cooldown: 60, currentCooldown: 0, duration: 10, resourceMultiplier: 2, isActive: false
            },
            RAPID_DEVELOPMENT: {
                id: "rapidDevelopment", name: "Rapid Development", cooldown: 90, currentCooldown: 0, duration: 5, developmentSpeedMultiplier: 3, isActive: false
            }
        };

        const MILESTONES_TEMPLATE = [
            { id: "complete_prehistory", name: "First Steps üêæ", description: "Complete the Prehistory era.", condition: (gs) => gs.completedEraIds.includes("prehistory"), reward: { knowledge: 50 }, claimed: false },
            { id: "reach_stone_age", name: "Dawn of Tool Use üõ†Ô∏è", description: "Reach the Stone Age.", condition: (gs) => gs.currentEraId === "stone_age", reward: { influence: 20 }, claimed: false },
            { id: "complete_3_eras", name: "Early Progress üìà", description: "Complete 3 different Eras in a single Epoch Shift.", condition: (gs) => gs.erasCompletedThisShift >= 3, reward: { knowledge: 200 }, claimed: false },
            { id: "earn_5000_knowledge", name: "Growing Wisdom üß†", description: "Accumulate 5000 total knowledge in a single Epoch Shift.", condition: (gs) => gs.knowledgeEarnedThisShift >= 5000, reward: { progressPerClick: 3 }, permanentBonus: { type: 'progressPerClick', value: 1 }, claimed: false },
            { id: "perform_epoch_shift", name: "Timeline Weaver üåÄ", description: "Perform your first Epoch Shift.", condition: (gs) => gs.epochShiftsPerformedTotal > 0, reward: { temporalShardsInstant: 1 }, permanentBonus: {type: 'globalProgressBonus', value: 0.02}, claimed: false},
            { id: "unlock_writing", name: "The Written Word ‚úçÔ∏è", description: "Complete the 'Early Writing Systems' development.", condition: (gs) => gs.completedDevelopmentIds.includes("writing_systems"), reward: { knowledge: 300, influence: 50 }, claimed: false },
        ];

        const PARADIGMS_TEMPLATE = {
            scientificMethod: { id: "scientificMethod", name: "üî¨ Scientific Method", description: "Systematic observation and experimentation enhances knowledge gain.", baseCostResource: "knowledge", baseCost: 20000, costMultiplier: 2, level: 0, maxLevel: 5, effectPerLevel: { knowledgeBonus: 0.05, breakthroughChance: 0.001 } }, 
            industrialization: { id: "industrialization", name: "üè≠ Industrialization", description: "Mass production accelerates societal momentum.", baseCostResource: "influence", baseCost: 15000, costMultiplier: 2.5, level: 0, maxLevel: 3, effectPerLevel: { passiveProgressRateBonus: 0.1, knowledgeFromDevelopments: 0.05 } }, 
            informationAge: { id: "informationAge", name: "üíª Information Age", description: "Global connectivity amplifies all progress.", baseCostResource: "knowledge", baseCost: 100000, costMultiplier: 3, level: 0, maxLevel: 5, effectPerLevel: { allResourceBonus: 0.03 } , unlockedAtEraId: "iron_age" },
        };
        
        const GLOBAL_EVENTS_TIMELINE = [
            { id: "ageOfDiscovery", name: "üó∫Ô∏è Age of Discovery!", duration: 300, influenceMultiplier: 1.5, message: "üó∫Ô∏è Age of Discovery! +50% Influence from all sources for 5 minutes!" },
            { id: "renaissance", name: "üé® Renaissance!", duration: 300, knowledgeMultiplier: 1.3, breakthroughChanceBonus: 0.05, message: "üé® Renaissance! +30% Knowledge & +5% Breakthrough Chance for 5 minutes!" },
            { id: "philosophicalFlourishing", name: "üí≠ Philosophical Flourishing!", duration: 180, passiveProgressMultiplier: 1.2, message: "üí≠ Time of Great Thinkers! +20% Societal Momentum for 3 minutes!" }
        ];
        let currentGlobalEvent = null;
        let globalEventTimer = 0;
        
        function getBaseAdvancementCost(base, level, multiplier = 1.2, flatIncrease = 10) {
            const eraOrder = ERA_DEFINITIONS.find(e => e.id === gameState.currentEraId)?.epochShiftRequirementOrder || 0;
            return Math.ceil(base * Math.pow(multiplier, level) + flatIncrease * level * (eraOrder + 1));
        }

        function getDefaultGameState() {
            const firstEra = ERA_DEFINITIONS[0];
            const baseState = {
                currentEraId: firstEra.id,
                currentDevelopmentIndex: 0,
                currentDevelopmentProgress: 0,
                knowledge: 0, influence: 0,
                progressPerClick: 1, knowledgePerClick: 0, passiveProgressRate: 0, 
                breakthroughChance: BREAKTHROUGH_CHANCE_BASE, breakthroughImpactBonus: 0.5, 
                erasCompletedThisShift: 0,
                advancementCosts: {
                    progressPerClick: 10, knowledgePerClick: 15, passiveProgressRate: 25, breakthroughChance: 100, breakthroughImpact: 150,
                    knowledgeAffinity: 2000, influenceSpread: 2000,
                },
                advancementLevels: {
                    progressPerClick: 0, knowledgePerClick: 0, passiveProgressRate: 0, breakthroughChance: 0, breakthroughImpact: 0,
                    knowledgeAffinity: 0, influenceSpread: 0
                },
                knowledgeAffinityBonus: 0, influenceSpreadBonus: 0,
                breakthroughs: JSON.parse(JSON.stringify(BREAKTHROUGHS_TEMPLATE)), 
                milestones: MILESTONES_TEMPLATE.map(templateMs => ({
                    ...templateMs, 
                    condition: templateMs.condition, 
                    reward: templateMs.reward ? JSON.parse(JSON.stringify(templateMs.reward)) : undefined,
                    permanentBonus: templateMs.permanentBonus ? JSON.parse(JSON.stringify(templateMs.permanentBonus)) : undefined,
                    claimed: false
                })),
                completedDevelopmentIds: [], completedEraIds: [], 
                knowledgeEarnedThisShift: 0, influenceEarnedThisShift: 0, totalClicks: 0, totalBreakthroughsUsed: 0,
                temporalShards: 0, epochShiftsPerformedTotal: 0,
                epochShiftUpgrades: { globalKnowledgeBonus: 0, globalInfluenceBonus: 0, globalProgressBonus: 0, startingKnowledgeLevel: 0, shardMultiplierLevel: 0 },
                epochShiftUpgradeCosts: { globalKnowledgeBonus: 1, globalInfluenceBonus: 1, globalProgressBonus: 2, startingKnowledgeLevel: 1, shardMultiplierLevel: 5 },
                paradigms: JSON.parse(JSON.stringify(PARADIGMS_TEMPLATE)),
                temporaryBonuses: { progressPerClick: 0, knowledgePerClick: 0, durationTicks: 0},
                lastDailyRewardClaimed: 0, lastSaveTime: Date.now(), lastActiveTime: Date.now()
            };
            return baseState;
        }
        
        function initGame() {
            gameState = loadGame();
            calculateOfflineProgress();
            
            const currentEra = getCurrentEraDefinition();
            if (!currentEra || !currentEra.developments || gameState.currentDevelopmentIndex >= currentEra.developments.length) {
                 startNewEra(gameState.currentEraId || ERA_DEFINITIONS[0].id); 
            } else {
                startSpecificDevelopment(gameState.currentEraId, gameState.currentDevelopmentIndex);
            }
            
            setupEventListeners();
            updateAllUI();
            checkUnlocksAndAvailability(); 
            renderMilestones();
            renderEpochShiftUpgrades();
            renderParadigms();
            checkDailyReward();
            
            setInterval(gameLoop, 100); 
            setInterval(passiveSave, 30000); 
            setInterval(tryStartGlobalEvent, 60 * 1000 * 5); 
        }

        function playSound(soundId) {  }
        
        function setupEventListeners() {
            document.getElementById('current-development-display').addEventListener('click', handleProgressClick);
            document.getElementById('adv-progress-per-click').addEventListener('click', () => buyAdvancement('progressPerClick'));
            document.getElementById('adv-knowledge-per-click').addEventListener('click', () => buyAdvancement('knowledgePerClick'));
            document.getElementById('adv-passive-progress').addEventListener('click', () => buyAdvancement('passiveProgressRate'));
            document.getElementById('adv-breakthrough-chance').addEventListener('click', () => buyAdvancement('breakthroughChance'));
            document.getElementById('adv-breakthrough-impact').addEventListener('click', () => buyAdvancement('breakthroughImpact'));
            document.getElementById('shift-knowledge-affinity').addEventListener('click', () => buyAdvancement('knowledgeAffinity'));
            document.getElementById('shift-influence-spread').addEventListener('click', () => buyAdvancement('influenceSpread'));

            document.getElementById('breakthrough-inspiredThought').addEventListener('click', () => activateBreakthrough('INSPIRED_THOUGHT'));
            document.getElementById('breakthrough-goldenAge').addEventListener('click', () => activateBreakthrough('GOLDEN_AGE'));
            document.getElementById('breakthrough-rapidDevelopment').addEventListener('click', () => activateBreakthrough('RAPID_DEVELOPMENT'));

            document.getElementById('epoch-shift-button').addEventListener('click', handleEpochShift);
            document.getElementById('eshift-global-knowledge').addEventListener('click', () => buyEpochShiftUpgrade('globalKnowledgeBonus'));
            document.getElementById('eshift-global-influence').addEventListener('click', () => buyEpochShiftUpgrade('globalInfluenceBonus'));
            document.getElementById('eshift-global-progress').addEventListener('click', () => buyEpochShiftUpgrade('globalProgressBonus'));
            document.getElementById('eshift-start-knowledge').addEventListener('click', () => buyEpochShiftUpgrade('startingKnowledgeLevel'));
            document.getElementById('eshift-shard-multiplier').addEventListener('click', () => buyEpochShiftUpgrade('shardMultiplierLevel'));
            
            Object.keys(PARADIGMS_TEMPLATE).forEach(pKey => {
                const paradigmButton = document.getElementById(PARADIGMS_TEMPLATE[pKey].id);
                 if (paradigmButton) { // Paradigms might be added dynamically later
                    paradigmButton.addEventListener('click', () => buyParadigm(pKey));
                }
            });


            document.getElementById('save-game').addEventListener('click', () => { saveGame(); displayMessage("üíæ Chronicle Saved!", "var(--success-color)"); });
            document.getElementById('load-game').addEventListener('click', () => { 
                gameState = loadGame(); 
                calculateOfflineProgress(); 
                const eraDef = getCurrentEraDefinition();
                if(!eraDef || !eraDef.developments || gameState.currentDevelopmentIndex >= eraDef.developments.length) {
                    startNewEra(gameState.currentEraId || ERA_DEFINITIONS[0].id);
                } else {
                    startSpecificDevelopment(gameState.currentEraId, gameState.currentDevelopmentIndex);
                }
                updateAllUI(); checkUnlocksAndAvailability(); renderMilestones(); renderEpochShiftUpgrades(); renderParadigms();
            });
            document.getElementById('reset-game').addEventListener('click', resetGame);
            document.getElementById('claim-daily-reward').addEventListener('click', claimDailyReward);
            document.getElementById('claim-offline-progress').addEventListener('click', () => {
                document.getElementById('offline-progress-popup').classList.remove('visible');
                 displayMessage("Offline gains observed! üìú", "var(--success-color)", 3000);
            });
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }
        
        function getCurrentEraDefinition() {
            return ERA_DEFINITIONS.find(e => e.id === gameState.currentEraId);
        }
        function getCurrentDevelopmentDefinition() {
            const era = getCurrentEraDefinition();
            if (era && era.developments && gameState.currentDevelopmentIndex < era.developments.length) {
                return era.developments[gameState.currentDevelopmentIndex];
            }
            return null;
        }


        function startNewEra(eraId) {
            const newEraDef = ERA_DEFINITIONS.find(e => e.id === eraId);
            if (!newEraDef) {
                startNewEra(ERA_DEFINITIONS[ERA_DEFINITIONS.length-1].id); // Go to last defined era if something goes wrong
                return;
            }

            gameState.currentEraId = newEraDef.id;
            gameState.currentDevelopmentIndex = 0;
            gameState.erasCompletedThisShift++;

            if (newEraDef.unlocksAdvancements) {
                newEraDef.unlocksAdvancements.forEach(advId => {
                    const advButton = document.getElementById(advId);
                    if (advButton) advButton.style.display = 'block';
                });
            }
             if (newEraDef.unlocksBreakthroughsAtStart) {
                newEraDef.unlocksBreakthroughsAtStart.forEach(btKey => {
                    const btButton = document.getElementById(`breakthrough-${BREAKTHROUGHS_TEMPLATE[btKey].id}`);
                    if(btButton && gameState.breakthroughs[btKey].currentCooldown <=0) btButton.disabled = false;
                });
            }
            if (newEraDef.unlocksParadigms) {
                newEraDef.unlocksParadigms.forEach(pKey => {
                    const pButton = document.getElementById(PARADIGMS_TEMPLATE[pKey].id);
                    if (pButton) pButton.style.display = 'block';
                });
            }


            const devDisplay = document.getElementById('current-development-display');
            devDisplay.style.backgroundColor = newEraDef.backgroundColor;
            devDisplay.style.borderColor = newEraDef.borderColor;
            devDisplay.classList.toggle('major-milestone', !!newEraDef.isMajorTurningPointEra);
            document.getElementById('era-flavor-text').textContent = newEraDef.description;

            displayMessage(`üï∞Ô∏è Advanced to the ${newEraDef.name}! New developments await.`, "var(--accent-color)", 4000);
            playSound('eraAdvanceSound');
            
            const gameWrapper = document.getElementById('game-wrapper'); // Screen effects for era change
            gameWrapper.classList.add('screen-shake');
            const flash = document.createElement('div');
            flash.className = 'screen-flash';
            document.body.appendChild(flash);
            setTimeout(() => {
                gameWrapper.classList.remove('screen-shake');
                if(document.body.contains(flash)) document.body.removeChild(flash);
            }, 500);


            startSpecificDevelopment(newEraDef.id, 0);
            checkUnlocksAndAvailability();
            updatePlayerStatsUI(); 
        }

        function startSpecificDevelopment(eraId, devIndex) {
            gameState.currentEraId = eraId; // Ensure eraId is set
            gameState.currentDevelopmentIndex = devIndex;
            gameState.currentDevelopmentProgress = 0;

            const development = getCurrentDevelopmentDefinition();
            if (!development) {
                // This might happen if an era has no developments, or trying to load an invalid state.
                // Attempt to move to the next era or handle error
                const currentEraIdx = ERA_DEFINITIONS.findIndex(e => e.id === gameState.currentEraId);
                if (currentEraIdx < ERA_DEFINITIONS.length - 1) {
                    startNewEra(ERA_DEFINITIONS[currentEraIdx + 1].id);
                } else {
                    displayMessage("All timelines explored... for now. Consider an Epoch Shift.", "var(--temporal-shard-color)");
                    // Potentially disable clicking or show an "end game" state for this shift
                }
                return;
            }
            
             if (development.unlocksAdvancements) { // Advancements unlocked by specific developments
                development.unlocksAdvancements.forEach(advId => {
                    const advButton = document.getElementById(advId);
                    if (advButton) advButton.style.display = 'block';
                });
            }

            updateDevelopmentUI();
            playSound('developmentStartSound');
        }


        function handleProgressClick() {
            const development = getCurrentDevelopmentDefinition();
            if (!development || gameState.currentDevelopmentProgress >= development.effortRequired) return; 
            
            gameState.totalClicks++;

            let baseProgPerClick = gameState.progressPerClick + gameState.temporaryBonuses.progressPerClick;
            let globalProgBonus = gameState.epochShiftUpgrades.globalProgressBonus;
            let progressMade = baseProgPerClick * (1 + globalProgBonus);

            let baseKnowPerClick = gameState.knowledgePerClick + gameState.temporaryBonuses.knowledgePerClick;
            let globalKnowBonus = gameState.epochShiftUpgrades.globalKnowledgeBonus + gameState.knowledgeAffinityBonus + (gameState.paradigms.scientificMethod.level * gameState.paradigms.scientificMethod.effectPerLevel.knowledgeBonus);
            let eventKnowMultiplier = (currentGlobalEvent?.knowledgeMultiplier) || 1;
            let paradigmKnowMultiplier = 1 + (gameState.paradigms.informationAge.level * (gameState.paradigms.informationAge.effectPerLevel?.allResourceBonus || 0));
            const clickKnowledgeAmount = Math.ceil(baseKnowPerClick * (1 + globalKnowBonus) * eventKnowMultiplier * paradigmKnowMultiplier);
            
            if (clickKnowledgeAmount > 0) {
                earnKnowledge(clickKnowledgeAmount); 
                displayFeedbackNumber(clickKnowledgeAmount, 'knowledge', 'resource-feedback-container');
            }
            
            let isBreakthrough = false;
            const effectiveBreakthroughChance = gameState.breakthroughChance + (currentGlobalEvent?.breakthroughChanceBonus || 0) + (gameState.paradigms.scientificMethod.level * gameState.paradigms.scientificMethod.effectPerLevel.breakthroughChance);
            if (Math.random() < effectiveBreakthroughChance) {
                progressMade *= (1 + gameState.breakthroughImpactBonus);
                isBreakthrough = true;
                displayMessage("‚ú® Breakthrough!", "var(--knowledge-color)", 1500);
            }
            progressMade = Math.ceil(progressMade);

            if (gameState.breakthroughs.RAPID_DEVELOPMENT.isActive) {
                progressMade *= BREAKTHROUGHS_TEMPLATE.RAPID_DEVELOPMENT.developmentSpeedMultiplier;
            }
            if (gameState.breakthroughs.INSPIRED_THOUGHT.isActive) { // Make Inspired Thought a short buff instead of instant
                 progressMade *= BREAKTHROUGHS_TEMPLATE.INSPIRED_THOUGHT.progressMultiplier;
            }


            gameState.currentDevelopmentProgress += progressMade;
            
            displayProgressNumber(progressMade, isBreakthrough);
            playSound(isBreakthrough ? 'breakthroughSound' : 'clickSound');

            if (gameState.currentDevelopmentProgress >= development.effortRequired) {
                playSound('developmentCompleteSound');
                completeDevelopment(); 
            }
            updateDevelopmentUI(); 
            checkMilestones();
            updatePlayerStatsUI();
        }

        function displayFeedbackNumber(value, type, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const el = document.createElement('span');
            el.className = 'feedback-number';
            let prefix = '';
            let suffix = '';
            if (type === 'progress') { el.classList.add('progress-number'); prefix = '+'; suffix = ' P'; }
            if (type === 'knowledge') { el.classList.add('knowledge-feedback'); prefix = '+'; suffix = ' üí°';}
            if (type === 'influence') { el.classList.add('influence-feedback'); prefix = '+'; suffix = ' üåç';}
            el.textContent = prefix + Math.ceil(value) + suffix;

            el.style.left = Math.random() * 50 + 25 + '%'; 
            el.style.top = Math.random() * 30 + 20 + '%';  
            
            container.appendChild(el);
            setTimeout(() => { if (container.contains(el)) container.removeChild(el); }, 790);
        }

        function displayProgressNumber(progress, isBreakthrough) {
             displayFeedbackNumber(progress, 'progress', 'progress-feedback-container');
             if(isBreakthrough) {
                const breakthroughEl = document.getElementById('progress-feedback-container').lastChild;
                if (breakthroughEl) breakthroughEl.classList.add('breakthrough-feedback');
             }
        }

        function completeDevelopment() {
            const development = getCurrentDevelopmentDefinition();
            if (!development) return; 

            let knowledgeMultiplier = (1 + gameState.epochShiftUpgrades.globalKnowledgeBonus + gameState.knowledgeAffinityBonus + (gameState.paradigms.scientificMethod.level * gameState.paradigms.scientificMethod.effectPerLevel.knowledgeBonus));
            let influenceMultiplier = (1 + gameState.epochShiftUpgrades.globalInfluenceBonus + gameState.influenceSpreadBonus);
            let paradigmResourceMultiplier = 1 + (gameState.paradigms.informationAge.level * (gameState.paradigms.informationAge.effectPerLevel?.allResourceBonus || 0));
            knowledgeMultiplier *= paradigmResourceMultiplier;
            influenceMultiplier *= paradigmResourceMultiplier;
            
            if(currentGlobalEvent) {
                if(currentGlobalEvent.knowledgeMultiplier) knowledgeMultiplier *= currentGlobalEvent.knowledgeMultiplier;
                if(currentGlobalEvent.influenceMultiplier) influenceMultiplier *= currentGlobalEvent.influenceMultiplier;
            }
            if (gameState.breakthroughs.GOLDEN_AGE.isActive) {
                knowledgeMultiplier *= BREAKTHROUGHS_TEMPLATE.GOLDEN_AGE.resourceMultiplier;
                influenceMultiplier *= BREAKTHROUGHS_TEMPLATE.GOLDEN_AGE.resourceMultiplier;
            }
            knowledgeMultiplier *= (1 + gameState.paradigms.industrialization.level * (gameState.paradigms.industrialization.effectPerLevel?.knowledgeFromDevelopments || 0));


            const knowledgeGained = Math.ceil((development.rewards.knowledge || 0) * knowledgeMultiplier);
            const influenceGained = Math.ceil((development.rewards.influence || 0) * influenceMultiplier);
            
            if (knowledgeGained > 0) {
                displayFeedbackNumber(knowledgeGained, 'knowledge', 'resource-feedback-container');
                earnKnowledge(knowledgeGained);
            }
            if (influenceGained > 0) {
                displayFeedbackNumber(influenceGained, 'influence', 'resource-feedback-container');
                earnInfluence(influenceGained);
            }
            
            if (development.rewards.tempProgressPerClickBonus) {
                gameState.temporaryBonuses.progressPerClick += development.rewards.tempProgressPerClickBonus;
                gameState.temporaryBonuses.durationTicks = Math.max(gameState.temporaryBonuses.durationTicks, development.rewards.tempBonusDurationTicks || 0);
            }
            if (development.rewards.tempKnowledgePerClickBonus) {
                 gameState.temporaryBonuses.knowledgePerClick += development.rewards.tempKnowledgePerClickBonus;
                 gameState.temporaryBonuses.durationTicks = Math.max(gameState.temporaryBonuses.durationTicks, development.rewards.tempBonusDurationTicks || 0);
            }
            if (development.rewards.breakthroughChanceBonus) {
                gameState.breakthroughChance += development.rewards.breakthroughChanceBonus;
            }


            if (!gameState.completedDevelopmentIds.includes(development.id)) {
                gameState.completedDevelopmentIds.push(development.id);
            }
            displayMessage(`üí° Development "${development.name}" Completed!`, "var(--success-color)", 2500);

            gameState.currentDevelopmentIndex++;
            const currentEra = getCurrentEraDefinition();
            
            if (gameState.currentDevelopmentIndex >= currentEra.developments.length) {
                if (!gameState.completedEraIds.includes(currentEra.id)) {
                    gameState.completedEraIds.push(currentEra.id);
                }
                const currentEraGlobalIndex = ERA_DEFINITIONS.findIndex(e => e.id === gameState.currentEraId);
                if (currentEraGlobalIndex < ERA_DEFINITIONS.length - 1) {
                    startNewEra(ERA_DEFINITIONS[currentEraGlobalIndex + 1].id);
                } else {
                    displayMessage("All known history unfolds... What lies beyond? Perhaps an Epoch Shift holds the answer.", "var(--temporal-shard-color)", 6000);
                    // Handle end of defined eras (e.g. prompt epoch shift or display 'content complete for now')
                }
            } else {
                startSpecificDevelopment(gameState.currentEraId, gameState.currentDevelopmentIndex);
            }
            
            updateAllUI();
            checkMilestones();
        }

        function earnKnowledge(amount) {
            gameState.knowledge += amount;
            gameState.knowledgeEarnedThisShift += amount;
        }
        function earnInfluence(amount) {
            gameState.influence += amount;
            gameState.influenceEarnedThisShift += amount;
        }
        
        function checkUnlocksAndAvailability() {
            const currentEra = getCurrentEraDefinition();
            if (!currentEra) return;

            Object.values(BREAKTHROUGHS_TEMPLATE).forEach(btDef => {
                 const button = document.getElementById(`breakthrough-${btDef.id}`);
                 if (button) {
                    const eraUnlocked = ERA_DEFINITIONS.findIndex(e => e.id === currentEra.id) >= ERA_DEFINITIONS.findIndex(era => era.unlocksBreakthroughsAtStart && era.unlocksBreakthroughsAtStart.includes(btDef.id.toUpperCase().replace(/ /g, '_')));
                    const isUnlockedByCurrentEra = currentEra.unlocksBreakthroughsAtStart?.includes(btDef.id.toUpperCase().replace(/ /g, '_'));
                    button.disabled = !( (isUnlockedByCurrentEra || eraUnlocked) && gameState.breakthroughs[btDef.id.toUpperCase().replace(/ /g, '_')]?.currentCooldown <= 0);
                 }
            });

            const advUnlocks = {
                "adv-progress-per-click": "stone_age", "adv-knowledge-per-click": "stone_age", "adv-passive-progress": "stone_age", // Example: hunter_gatherers development in stone_age
                "adv-breakthrough-chance": "neolithic_age", "adv-breakthrough-impact": "bronze_age",
                "shift-knowledge-affinity": "bronze_age", "shift-influence-spread": "iron_age"
            };

            Object.keys(advUnlocks).forEach(advId => {
                const btn = document.getElementById(advId);
                if (btn) {
                    const requiredEraId = advUnlocks[advId];
                    const requiredEraOrder = ERA_DEFINITIONS.find(e => e.id === requiredEraId)?.epochShiftRequirementOrder || 999;
                    const currentEraOrder = currentEra.epochShiftRequirementOrder;
                    btn.style.display = currentEraOrder >= requiredEraOrder ? 'block' : 'none';
                }
            });
            
            // Check development-specific unlocks
            const currentDev = getCurrentDevelopmentDefinition();
            if (currentDev && currentDev.unlocksAdvancements) {
                 currentDev.unlocksAdvancements.forEach(advId => {
                    const advButton = document.getElementById(advId);
                    if (advButton) advButton.style.display = 'block';
                });
            }


             Object.values(PARADIGMS_TEMPLATE).forEach(pDef => {
                const pButton = document.getElementById(pDef.id);
                if (pButton) {
                    const unlockEraId = pDef.unlockedAtEraId || ERA_DEFINITIONS.find(e => e.unlocksParadigms && e.unlocksParadigms.includes(pDef.id))?.id;
                    const requiredEraOrder = ERA_DEFINITIONS.find(e => e.id === unlockEraId)?.epochShiftRequirementOrder || 999;
                    const currentEraOrder = currentEra.epochShiftRequirementOrder;
                    pButton.style.display = currentEraOrder >= requiredEraOrder ? 'block' : 'none';
                }
             });


             const shiftRequiredEra = ERA_DEFINITIONS.find(e => e.epochShiftRequirementOrder === EPOCH_SHIFT_REQUIRED_ERA_ORDER);
             if (shiftRequiredEra) {
                const canEpochShift = currentEra.epochShiftRequirementOrder >= shiftRequiredEra.epochShiftRequirementOrder;
                document.getElementById('epoch-shift-tab-button').style.display = canEpochShift ? 'inline-block' : 'none';
                document.getElementById('epoch-shift-button').disabled = !canEpochShift;
                document.getElementById('epoch-shift-required-era-name-display').textContent = shiftRequiredEra.name;
             }
        }


        function buyAdvancement(type) {
            let cost = gameState.advancementCosts[type];
            let purchased = false;
            let resource = 'influence'; 

            if (['progressPerClick', 'passiveProgressRate', 'breakthroughChance', 'breakthroughImpact', 'knowledgeAffinity'].includes(type)) resource = 'knowledge';


            if ((resource === 'knowledge' && gameState.knowledge >= cost) || (resource === 'influence' && gameState.influence >= cost)) {
                if (resource === 'knowledge') gameState.knowledge -= cost; else gameState.influence -= cost;
                gameState.advancementLevels[type]++;
                const level = gameState.advancementLevels[type];
                const currentEraOrder = getCurrentEraDefinition()?.epochShiftRequirementOrder || 0;

                switch (type) {
                    case 'progressPerClick':
                        const progIncrease = Math.max(1, Math.ceil(gameState.progressPerClick * 0.1 + currentEraOrder * 0.25 + 1));
                        gameState.progressPerClick += progIncrease;
                        gameState.advancementCosts.progressPerClick = getBaseAdvancementCost(10, level, 1.18, 8);
                        break;
                    case 'knowledgePerClick':
                        const knowIncrease = Math.max(1, Math.ceil(gameState.knowledgePerClick * 0.15 + Math.max(1, currentEraOrder * 0.1) + 1));
                        gameState.knowledgePerClick += knowIncrease;
                        gameState.advancementCosts.knowledgePerClick = getBaseAdvancementCost(15, level, 1.25, 10);
                        break;
                    case 'passiveProgressRate':
                        const rateIncrease = Math.max(1, Math.ceil(gameState.passiveProgressRate * 0.08 + 1 + currentEraOrder * 0.2));
                        gameState.passiveProgressRate += rateIncrease;
                        gameState.advancementCosts.passiveProgressRate = getBaseAdvancementCost(25, level, 1.22, 12);
                        break;
                    case 'breakthroughChance':
                        if (gameState.breakthroughChance < 0.50) { gameState.breakthroughChance += 0.0025; }
                        gameState.advancementCosts.breakthroughChance = getBaseAdvancementCost(100, level, 1.35, 30);
                        break;
                    case 'breakthroughImpact':
                         if (gameState.breakthroughImpactBonus < 3.0) { gameState.breakthroughImpactBonus += 0.05; }
                        gameState.advancementCosts.breakthroughImpact = getBaseAdvancementCost(150, level, 1.28, 35);
                        break;
                    case 'knowledgeAffinity':
                        gameState.knowledgeAffinityBonus += 0.02;
                        gameState.advancementCosts.knowledgeAffinity = getBaseAdvancementCost(2000, level, 1.6, 60);
                        break;
                    case 'influenceSpread':
                        gameState.influenceSpreadBonus += 0.02;
                        gameState.advancementCosts.influenceSpread = getBaseAdvancementCost(2000, level, 1.6, 60);
                        break;
                }
                purchased = true;
            }
            
            if (purchased) playSound('advancementPurchased');
            else if (cost > 0) displayMessage(`Not enough ${resource === 'knowledge' ? 'Knowledge üí°' : 'Influence üåç'}!`, "var(--error-color)");
            
            updateAllUI();
        }
        
        function activateBreakthrough(breakthroughKey) {
            const breakthroughDef = BREAKTHROUGHS_TEMPLATE[breakthroughKey];
            const breakthroughState = gameState.breakthroughs[breakthroughKey];
            const currentEra = getCurrentEraDefinition();
             if (!currentEra) return;

            const isUnlockedByCurrentEra = currentEra.unlocksBreakthroughsAtStart?.includes(breakthroughKey);
            let eraHasAbilityUnlock = false;
             ERA_DEFINITIONS.forEach(eraDef => {
                if(eraDef.epochShiftRequirementOrder <= currentEra.epochShiftRequirementOrder && eraDef.unlocksBreakthroughsAtStart?.includes(breakthroughKey)){
                    eraHasAbilityUnlock = true;
                }
            });


            if (!breakthroughDef || !breakthroughState || !eraHasAbilityUnlock) {
                 displayMessage("Breakthrough not available yet! üîí", "var(--error-color)");
                 return;
            }
            if (breakthroughState.currentCooldown > 0) {
                displayMessage(`${breakthroughDef.name} is recharging! ‚è≥`, "var(--error-color)");
                return;
            }
            breakthroughState.currentCooldown = breakthroughDef.cooldown;
            gameState.totalBreakthroughsUsed++;
            displayMessage(`${breakthroughDef.name} Activated! ‚ú®`, "var(--success-color)");
            playSound('breakthroughActivate');
            
            const glowEffect = document.createElement('div');
            glowEffect.className = 'breakthrough-glow';
            if (breakthroughKey === 'GOLDEN_AGE') glowEffect.style.boxShadow = 'inset 0 0 30px 15px var(--influence-color)'; 
            document.body.appendChild(glowEffect);
            setTimeout(() => { if(document.body.contains(glowEffect)) document.body.removeChild(glowEffect);}, 600);

            breakthroughState.isActive = true; 
            updatePlayerStatsUI(); // Update stats to reflect active buff

            setTimeout(() => {
                breakthroughState.isActive = false;
                displayMessage(`‚ö° ${breakthroughDef.name} effect ended.`, "var(--text-color)");
                updatePlayerStatsUI(); // Update stats again when buff ends
            }, breakthroughDef.duration * 1000 || 100); // If no duration (like inspired thought), very short active time for logic

            checkMilestones();
            updateBreakthroughsUI(); 
        }

        function gameLoop() { 
            const development = getCurrentDevelopmentDefinition();
            if (gameState.passiveProgressRate > 0 && development && gameState.currentDevelopmentProgress < development.effortRequired) {
                let progressPerTick = gameState.passiveProgressRate * 0.1 * (1 + gameState.epochShiftUpgrades.globalProgressBonus);
                progressPerTick *= (1 + (gameState.paradigms.industrialization.level * (gameState.paradigms.industrialization.effectPerLevel?.passiveProgressRateBonus || 0)));
                progressPerTick *= (1 + (gameState.paradigms.informationAge.level * (gameState.paradigms.informationAge.effectPerLevel?.allResourceBonus || 0)));


                if (currentGlobalEvent && currentGlobalEvent.passiveProgressMultiplier) progressPerTick *= currentGlobalEvent.passiveProgressMultiplier;
                if (gameState.breakthroughs.RAPID_DEVELOPMENT.isActive) {
                    progressPerTick *= BREAKTHROUGHS_TEMPLATE.RAPID_DEVELOPMENT.developmentSpeedMultiplier;
                }
                gameState.currentDevelopmentProgress += progressPerTick;
                if (gameState.currentDevelopmentProgress >= development.effortRequired) {
                    completeDevelopment();
                }
                updateDevelopmentUI();
            }

            for (const key in BREAKTHROUGHS_TEMPLATE) { 
                const breakthroughDef = BREAKTHROUGHS_TEMPLATE[key];
                const breakthroughState = gameState.breakthroughs[key];
                if (breakthroughState && breakthroughState.currentCooldown > 0) { 
                    breakthroughState.currentCooldown -= 0.1; 
                    if (breakthroughState.currentCooldown < 0) {
                        breakthroughState.currentCooldown = 0;
                         checkUnlocksAndAvailability(); // Re-check if button should be enabled
                    }
                }
            }
             if (gameState.temporaryBonuses.durationTicks > 0) {
                gameState.temporaryBonuses.durationTicks -= 1;
                if (gameState.temporaryBonuses.durationTicks <= 0) {
                    gameState.temporaryBonuses.progressPerClick = 0;
                    gameState.temporaryBonuses.knowledgePerClick = 0;
                    displayMessage("Temporary bonuses faded.", "var(--text-color)", 2000);
                    updatePlayerStatsUI();
                }
            }

            updateBreakthroughsUI();

            if (currentGlobalEvent) {
                globalEventTimer -= 0.1;
                if (globalEventTimer <= 0) {
                    endGlobalEvent();
                } else {
                    document.getElementById('global-event-display').textContent = `${currentGlobalEvent.message} (Ends in ${Math.ceil(globalEventTimer)}s)`;
                }
            }
            gameState.lastActiveTime = Date.now(); 
        }

        function updateAllUI() {
            updatePlayerStatsUI(); 
            updateDevelopmentUI(); 
            updateAdvancementsUI();
            updateBreakthroughsUI(); 
            updateEpochShiftUI();
            renderParadigms();
        }

        function updatePlayerStatsUI() {
            const currentEra = getCurrentEraDefinition();
            if (!currentEra) return;

            document.getElementById('current-era-name').textContent = currentEra.name;
            document.getElementById('era-developments-completed').textContent = gameState.currentDevelopmentIndex;
            document.getElementById('era-developments-total').textContent = currentEra.developments.length;
            document.getElementById('era-progress-bar').style.width = Math.min(100, (gameState.currentDevelopmentIndex / currentEra.developments.length) * 100) + '%';
            
            document.getElementById('knowledge').textContent = Math.floor(gameState.knowledge);
            document.getElementById('influence').textContent = Math.floor(gameState.influence);
            
            let displayProgPerClick = gameState.progressPerClick + gameState.temporaryBonuses.progressPerClick;
            displayProgPerClick *= (1 + gameState.epochShiftUpgrades.globalProgressBonus);
            if(gameState.breakthroughs.RAPID_DEVELOPMENT.isActive) displayProgPerClick *= BREAKTHROUGHS_TEMPLATE.RAPID_DEVELOPMENT.developmentSpeedMultiplier;
            if(gameState.breakthroughs.INSPIRED_THOUGHT.isActive) displayProgPerClick *= BREAKTHROUGHS_TEMPLATE.INSPIRED_THOUGHT.progressMultiplier;
            displayProgPerClick *= (1 + (gameState.paradigms.informationAge.level * (gameState.paradigms.informationAge.effectPerLevel?.allResourceBonus || 0)));
            document.getElementById('progress-per-click').textContent = Math.ceil(displayProgPerClick);

            let displayKnowledgePerClick = gameState.knowledgePerClick + gameState.temporaryBonuses.knowledgePerClick;
            displayKnowledgePerClick *= (1 + gameState.epochShiftUpgrades.globalKnowledgeBonus + gameState.knowledgeAffinityBonus + (gameState.paradigms.scientificMethod.level * gameState.paradigms.scientificMethod.effectPerLevel.knowledgeBonus));
            displayKnowledgePerClick *= (currentGlobalEvent?.knowledgeMultiplier || 1);
            if(gameState.breakthroughs.GOLDEN_AGE.isActive) displayKnowledgePerClick *= BREAKTHROUGHS_TEMPLATE.GOLDEN_AGE.resourceMultiplier;
            displayKnowledgePerClick *= (1 + (gameState.paradigms.informationAge.level * (gameState.paradigms.informationAge.effectPerLevel?.allResourceBonus || 0)));
            document.getElementById('knowledge-per-click').textContent = Math.ceil(displayKnowledgePerClick);
            
            let displayPassiveProgress = gameState.passiveProgressRate;
            displayPassiveProgress *= (1 + gameState.epochShiftUpgrades.globalProgressBonus);
            displayPassiveProgress *= (1 + (gameState.paradigms.industrialization.level * (gameState.paradigms.industrialization.effectPerLevel?.passiveProgressRateBonus || 0)));
            displayPassiveProgress *= (1 + (gameState.paradigms.informationAge.level * (gameState.paradigms.informationAge.effectPerLevel?.allResourceBonus || 0)));
            if(currentGlobalEvent?.passiveProgressMultiplier) displayPassiveProgress *= currentGlobalEvent.passiveProgressMultiplier;
            if(gameState.breakthroughs.RAPID_DEVELOPMENT.isActive) displayPassiveProgress *= BREAKTHROUGHS_TEMPLATE.RAPID_DEVELOPMENT.developmentSpeedMultiplier;
            document.getElementById('passive-progress-rate').textContent = Math.ceil(displayPassiveProgress);

            document.getElementById('breakthrough-chance').textContent = ((gameState.breakthroughChance + (currentGlobalEvent?.breakthroughChanceBonus || 0) + (gameState.paradigms.scientificMethod.level * gameState.paradigms.scientificMethod.effectPerLevel.breakthroughChance)) * 100).toFixed(1);
            document.getElementById('breakthrough-impact-bonus').textContent = (gameState.breakthroughImpactBonus * 100).toFixed(0);
            document.getElementById('eras-completed-this-shift').textContent = gameState.erasCompletedThisShift;
            document.getElementById('global-knowledge-bonus-display').textContent = ((gameState.epochShiftUpgrades.globalKnowledgeBonus + gameState.knowledgeAffinityBonus) * 100).toFixed(1);
            document.getElementById('global-influence-bonus-display').textContent = ((gameState.epochShiftUpgrades.globalInfluenceBonus + gameState.influenceSpreadBonus) * 100).toFixed(1);
            document.getElementById('global-progress-bonus-display').textContent = (gameState.epochShiftUpgrades.globalProgressBonus * 100).toFixed(1);
            document.getElementById('current-temporal-shards-display').textContent = gameState.temporalShards;
        }

        function updateDevelopmentUI() {
            const development = getCurrentDevelopmentDefinition();
            const era = getCurrentEraDefinition();
            if (development && era) {
                document.getElementById('development-name').textContent = development.name + (development.isKeyDevelopment ? " (Key!)" : "");
                document.getElementById('development-description').textContent = development.description;
                document.getElementById('development-current-progress').textContent = Math.max(0, Math.ceil(gameState.currentDevelopmentProgress));
                document.getElementById('development-max-progress').textContent = development.effortRequired;
                const progressPercentage = (Math.max(0, gameState.currentDevelopmentProgress) / development.effortRequired) * 100;
                document.getElementById('development-progress-bar').style.width = progressPercentage + '%';
                document.getElementById('development-progress-bar').style.backgroundColor = progressPercentage > 60 ? 'var(--development-progress-color)' : progressPercentage > 30 ? 'var(--influence-color)' : 'var(--error-color)';
                document.getElementById('current-development-display').classList.toggle('major-milestone', !!development.isKeyDevelopment || !!era.isMajorTurningPointEra);

            } else if (era) { // Era might be completed or no developments left
                 document.getElementById('development-name').textContent = "Era Complete";
                 document.getElementById('development-description').textContent = `All developments for ${era.name} finished. Awaiting next Era or Epoch Shift.`;
                 document.getElementById('development-progress-bar').style.width = '100%';
            }
        }
        
        function updateAdvancementsUI() {
            const pLvl = gameState.advancementLevels.progressPerClick;
            const kLvl = gameState.advancementLevels.knowledgePerClick;
            const srLvl = gameState.advancementLevels.passiveProgressRate;
            const bcLvl = gameState.advancementLevels.breakthroughChance;
            const biLvl = gameState.advancementLevels.breakthroughImpact;
            const kaLvl = gameState.advancementLevels.knowledgeAffinity;
            const isLvl = gameState.advancementLevels.influenceSpread;

            document.getElementById('adv-progress-per-click').innerHTML = `üñ±Ô∏è Enhance Focus Lvl ${pLvl} <small>(Cost: ${gameState.advancementCosts.progressPerClick}üí° | Current: ${Math.ceil(gameState.progressPerClick + gameState.temporaryBonuses.progressPerClick)})</small>`;
            document.getElementById('adv-knowledge-per-click').innerHTML = `üí° Refine Observation Lvl ${kLvl} <small>(Cost: ${gameState.advancementCosts.knowledgePerClick}üåç | Current: ${Math.ceil(gameState.knowledgePerClick + gameState.temporaryBonuses.knowledgePerClick)})</small>`;
            document.getElementById('adv-passive-progress').innerHTML = `üìà Improve Organization Lvl ${srLvl} <small>(Cost: ${gameState.advancementCosts.passiveProgressRate}üí° | Current: ${Math.ceil(gameState.passiveProgressRate)})</small>`;
            document.getElementById('adv-breakthrough-chance').innerHTML = `‚ú® Foster Innovation Lvl ${bcLvl} <small>(Cost: ${gameState.advancementCosts.breakthroughChance}üí° | +${(gameState.breakthroughChance*100).toFixed(1)}%)</small>`;
            document.getElementById('adv-breakthrough-impact').innerHTML = `üí• Amplify Discoveries Lvl ${biLvl} <small>(Cost: ${gameState.advancementCosts.breakthroughImpact}üí° | +${(gameState.breakthroughImpactBonus*100).toFixed(0)}%)</small>`;
            
            document.getElementById('shift-knowledge-affinity').innerHTML = `üí° Knowledge Affinity Lvl ${kaLvl} <small>(Cost: ${gameState.advancementCosts.knowledgeAffinity}üí° | +${(gameState.knowledgeAffinityBonus*100).toFixed(0)}%)</small>`;
            document.getElementById('shift-influence-spread').innerHTML = `üåç Cultural Exchange Lvl ${isLvl} <small>(Cost: ${gameState.advancementCosts.influenceSpread}üåç | +${(gameState.influenceSpreadBonus*100).toFixed(0)}%)</small>`;
        }
        
        function updateBreakthroughsUI() {
            for (const key in BREAKTHROUGHS_TEMPLATE) { 
                const breakthroughDef = BREAKTHROUGHS_TEMPLATE[key];
                const breakthroughState = gameState.breakthroughs[key];
                const button = document.getElementById(`breakthrough-${breakthroughDef.id}`);
                const cooldownBar = document.getElementById(`${breakthroughDef.id.substring(0,2).toLowerCase()}-cooldown-bar`); 
                const cooldownDisplay = document.getElementById(`${breakthroughDef.id.substring(0,2).toLowerCase()}-cooldown-display`);

                if(button && cooldownBar && cooldownDisplay && breakthroughState) { 
                    cooldownDisplay.textContent = Math.ceil(breakthroughState.currentCooldown);
                    // Unlock logic is handled in checkUnlocksAndAvailability now
                    button.disabled = breakthroughState.currentCooldown > 0 || button.disabled; // Preserve disabled state if unlocked=false
                    
                    if (breakthroughState.currentCooldown > 0) {
                        cooldownBar.style.width = ((breakthroughDef.cooldown - breakthroughState.currentCooldown) / breakthroughDef.cooldown) * 100 + '%';
                    } else {
                        cooldownBar.style.width = '100%';
                    }
                }
            }
        }


        function displayMessage(message, color = "var(--success-color)", duration = 3000) {
            const messagesArea = document.getElementById('messages-area');
            messagesArea.innerHTML = message; 
            messagesArea.style.color = color;
            if(messagesArea.timeoutId) clearTimeout(messagesArea.timeoutId);
            messagesArea.timeoutId = setTimeout(() => {
                messagesArea.innerHTML = '';
                messagesArea.style.color = "var(--success-color)"; 
            }, duration);
        }
        

        function renderMilestones() {
            const container = document.getElementById('milestones-container');
            if(!container) return;
            container.innerHTML = '';
            let completedCount = 0;
            gameState.milestones.forEach(milestone => {
                const stoneDiv = document.createElement('div');
                stoneDiv.classList.add('milestone');
                
                let isConditionMet = false;
                if (typeof milestone.condition === 'function') { 
                    isConditionMet = milestone.condition(gameState);
                }

                if (milestone.claimed) {
                    stoneDiv.classList.add('completed');
                    completedCount++;
                }
                let stoneHTML = `<h4>${milestone.name} ${milestone.claimed ? "‚úîÔ∏è" : "‚è≥"}</h4><p>${milestone.description}</p>`;
                if(milestone.reward) {
                    stoneHTML += `<small>üéÅ Reward: ${formatMilestoneReward(milestone.reward)}</small>`;
                }
                if (milestone.permanentBonus) {
                    stoneHTML += `<br><small>üí™ Permanent Bonus: ${formatMilestonePermanentBonus(milestone.permanentBonus)}</small>`;
                }
                stoneDiv.innerHTML = stoneHTML;

                if (!milestone.claimed && isConditionMet) {
                     const claimButton = document.createElement('button');
                     claimButton.textContent = 'Claim!';
                     claimButton.onclick = () => claimMilestone(milestone.id);
                     stoneDiv.appendChild(claimButton); 
                }
                container.appendChild(stoneDiv);
            });
            document.getElementById('milestones-completed-count').textContent = completedCount;
            document.getElementById('milestones-total-count').textContent = gameState.milestones.length;
            document.getElementById('milestones-count').textContent = `${completedCount}/${gameState.milestones.length}`;
        }

        function formatMilestoneReward(reward) {
            let str = "";
            if(reward.knowledge) str += `üí°${reward.knowledge}K `;
            if(reward.influence) str += `üåç${reward.influence}I `;
            if(reward.progressPerClick) str += `üñ±Ô∏è+${reward.progressPerClick} Prog/Click `;
            if(reward.temporalShardsInstant) str += `üåÄ${reward.temporalShardsInstant} TS `;
            return str.trim();
        }
        function formatMilestonePermanentBonus(bonus) {
            let str = "";
            if (bonus.type === 'progressPerClick') str = `üñ±Ô∏è+${bonus.value} Prog/Click`;
            if (bonus.type === 'globalProgressBonus') str = `üìà+${(bonus.value * 100).toFixed(0)}% Global Prog`;
            return str;
        }

        function checkMilestones() {
            let changed = false;
            gameState.milestones.forEach(milestone => {
                if (!milestone.claimed && typeof milestone.condition === 'function' && milestone.condition(gameState)) {
                    changed = true;
                }
            });
            if(changed) renderMilestones();
        }

        function claimMilestone(id) {
            const milestone = gameState.milestones.find(m => m.id === id);
            if (milestone && !milestone.claimed && typeof milestone.condition === 'function' && milestone.condition(gameState)) {
                milestone.claimed = true;
                if (milestone.reward) {
                    if (milestone.reward.knowledge) earnKnowledge(milestone.reward.knowledge);
                    if (milestone.reward.influence) earnInfluence(milestone.reward.influence);
                    if (milestone.reward.progressPerClick) gameState.progressPerClick += milestone.reward.progressPerClick;
                    if (milestone.reward.temporalShardsInstant) gameState.temporalShards += milestone.reward.temporalShardsInstant;
                }
                if (milestone.permanentBonus) {
                    applyMilestonePermanentBonus(milestone.permanentBonus);
                }
                displayMessage(`üèÜ Milestone "${milestone.name}" Achieved! üéâ`, "var(--success-color)", 4000);
                playSound('milestoneClaim');
                renderMilestones();
                updateAllUI();
            }
        }
        function applyMilestonePermanentBonus(bonus) {
             if (bonus.type === 'progressPerClick') gameState.progressPerClick += bonus.value;
             if (bonus.type === 'globalProgressBonus') gameState.epochShiftUpgrades.globalProgressBonus += bonus.value;
        }


        function updateEpochShiftUI() {
            const currentEra = getCurrentEraDefinition();
            if (!currentEra) return;
            const shiftRequiredEra = ERA_DEFINITIONS.find(e => e.epochShiftRequirementOrder === EPOCH_SHIFT_REQUIRED_ERA_ORDER);
            
            let pointsToGain = 0;
            if (shiftRequiredEra && currentEra.epochShiftRequirementOrder >= shiftRequiredEra.epochShiftRequirementOrder) {
                const erasBeyondRequirement = currentEra.epochShiftRequirementOrder - shiftRequiredEra.epochShiftRequirementOrder + 1;
                 pointsToGain = Math.floor(Math.pow(erasBeyondRequirement * 1.5 + gameState.completedEraIds.length * 0.1, 1.3) * (1 + gameState.epochShiftUpgrades.shardMultiplierLevel * 0.1));
            }

            document.getElementById('temporal-shards-to-gain').textContent = pointsToGain;
            document.getElementById('current-temporal-shards').textContent = gameState.temporalShards;
            if (shiftRequiredEra) {
                 document.getElementById('epoch-shift-required-era-name-display').textContent = shiftRequiredEra.name;
            }


            document.getElementById('eshift-global-knowledge').innerHTML = `üí° Global Knowledge Lvl ${Math.floor(gameState.epochShiftUpgrades.globalKnowledgeBonus * 100)} <small>(+${(gameState.epochShiftUpgrades.globalKnowledgeBonus*100).toFixed(0)}% | Cost: ${gameState.epochShiftUpgradeCosts.globalKnowledgeBonus}üåÄ)</small>`;
            document.getElementById('eshift-global-influence').innerHTML = `üåç Global Influence Lvl ${Math.floor(gameState.epochShiftUpgrades.globalInfluenceBonus * 100)} <small>(+${(gameState.epochShiftUpgrades.globalInfluenceBonus*100).toFixed(0)}% | Cost: ${gameState.epochShiftUpgradeCosts.globalInfluenceBonus}üåÄ)</small>`;
            document.getElementById('eshift-global-progress').innerHTML = `üìà Global Progress Lvl ${Math.floor(gameState.epochShiftUpgrades.globalProgressBonus * 50)} <small>(+${(gameState.epochShiftUpgrades.globalProgressBonus*100).toFixed(0)}% | Cost: ${gameState.epochShiftUpgradeCosts.globalProgressBonus}üåÄ)</small>`;
            document.getElementById('eshift-start-knowledge').innerHTML = `üß† Starting Knowledge Lvl ${gameState.epochShiftUpgrades.startingKnowledgeLevel} <small>(+${gameState.epochShiftUpgrades.startingKnowledgeLevel * 100}üí° | Cost: ${gameState.epochShiftUpgradeCosts.startingKnowledgeLevel}üåÄ)</small>`;
            document.getElementById('eshift-shard-multiplier').innerHTML = `üåÄ Shard Multiplier Lvl ${gameState.epochShiftUpgrades.shardMultiplierLevel} <small>(+${gameState.epochShiftUpgrades.shardMultiplierLevel * 10}% üåÄ | Cost: ${gameState.epochShiftUpgradeCosts.shardMultiplierLevel}üåÄ)</small>`;
        }

        function handleEpochShift() {
            const currentEra = getCurrentEraDefinition();
            const shiftRequiredEraDef = ERA_DEFINITIONS.find(e => e.epochShiftRequirementOrder === EPOCH_SHIFT_REQUIRED_ERA_ORDER);

            if (!currentEra || !shiftRequiredEraDef || currentEra.epochShiftRequirementOrder < shiftRequiredEraDef.epochShiftRequirementOrder) {
                displayMessage(`You need to reach the ${shiftRequiredEraDef?.name || 'designated Era'} to perform an Epoch Shift. ‚è≥`, "var(--error-color)");
                return;
            }
            if (confirm("üåÄ Are you sure you want to perform an Epoch Shift? This will reset your current timeline progress for powerful Temporal Shards and permanent bonuses! üåÄ")) {
                const erasBeyondRequirement = currentEra.epochShiftRequirementOrder - shiftRequiredEraDef.epochShiftRequirementOrder + 1;
                const pointsGained = Math.floor(Math.pow(erasBeyondRequirement * 1.5 + gameState.completedEraIds.length * 0.1, 1.3) * (1 + gameState.epochShiftUpgrades.shardMultiplierLevel * 0.1));
                
                gameState.temporalShards += pointsGained;
                gameState.epochShiftsPerformedTotal++;

                const esUpgrades = JSON.parse(JSON.stringify(gameState.epochShiftUpgrades));
                const tShards = gameState.temporalShards;
                const esCount = gameState.epochShiftsPerformedTotal;
                const claimedMilestonePermBonuses = gameState.milestones
                    .filter(m => m.claimed && m.permanentBonus)
                    .map(m => ({ ...m.permanentBonus })); 
                const oldMilestonesState = gameState.milestones.map(m => ({id: m.id, claimed: m.claimed }));
                const oldParadigms = JSON.parse(JSON.stringify(gameState.paradigms)); 

                let defaultGS = getDefaultGameState(); 
                gameState.currentEraId = defaultGS.currentEraId;
                gameState.currentDevelopmentIndex = defaultGS.currentDevelopmentIndex;
                gameState.currentDevelopmentProgress = defaultGS.currentDevelopmentProgress;
                gameState.knowledge = defaultGS.knowledge;
                gameState.influence = defaultGS.influence;
                gameState.progressPerClick = defaultGS.progressPerClick; // Permanent bonuses from milestones re-applied below
                gameState.knowledgePerClick = defaultGS.knowledgePerClick;
                gameState.passiveProgressRate = defaultGS.passiveProgressRate;
                gameState.breakthroughChance = defaultGS.breakthroughChance;
                gameState.breakthroughImpactBonus = defaultGS.breakthroughImpactBonus;
                gameState.erasCompletedThisShift = 0;
                gameState.advancementCosts = JSON.parse(JSON.stringify(defaultGS.advancementCosts));
                gameState.advancementLevels = JSON.parse(JSON.stringify(defaultGS.advancementLevels));
                gameState.knowledgeAffinityBonus = defaultGS.knowledgeAffinityBonus;
                gameState.influenceSpreadBonus = defaultGS.influenceSpreadBonus;
                gameState.breakthroughs = JSON.parse(JSON.stringify(defaultGS.breakthroughs));
                gameState.completedDevelopmentIds = [];
                gameState.completedEraIds = [];
                gameState.knowledgeEarnedThisShift = 0;
                gameState.influenceEarnedThisShift = 0;
                // totalClicks and totalBreakthroughsUsed are NOT reset by default
                gameState.temporaryBonuses = { progressPerClick: 0, knowledgePerClick: 0, durationTicks: 0};


                gameState.epochShiftUpgrades = esUpgrades;
                gameState.temporalShards = tShards;
                gameState.epochShiftsPerformedTotal = esCount;
                gameState.knowledge += gameState.epochShiftUpgrades.startingKnowledgeLevel * 100; 
                
                // Restore paradigm levels, but their costs will be recalculated based on new era
                Object.keys(gameState.paradigms).forEach(pKey => {
                    if(oldParadigms[pKey]) gameState.paradigms[pKey].level = oldParadigms[pKey].level;
                });
                
                gameState.milestones = MILESTONES_TEMPLATE.map(templateMilestone => {
                    const oldMilestoneData = oldMilestonesState.find(om => om.id === templateMilestone.id);
                    return { 
                        ...templateMilestone,
                        condition: templateMilestone.condition,
                        reward: templateMilestone.reward ? JSON.parse(JSON.stringify(templateMilestone.reward)) : undefined,
                        permanentBonus: templateMilestone.permanentBonus ? JSON.parse(JSON.stringify(templateMilestone.permanentBonus)) : undefined,
                        claimed: oldMilestoneData ? oldMilestoneData.claimed : false,
                    };
                });
                
                claimedMilestonePermBonuses.forEach(bonus => applyMilestonePermanentBonus(bonus)); // Re-apply permanent bonuses

                startNewEra(ERA_DEFINITIONS[0].id); // Start from the very beginning era
                checkUnlocksAndAvailability();
                updateAllUI();
                renderMilestones();
                renderEpochShiftUpgrades();
                renderParadigms();
                displayMessage(`üåÄ EPOCH SHIFT COMPLETE! Gained ${pointsGained}üåÄ. A new timeline dawns! ‚ú®`, "var(--temporal-shard-color)", 6000);
                playSound('epochShiftSound');
                openTab('gameTab');
            }
        }

        function buyEpochShiftUpgrade(type) {
            const cost = gameState.epochShiftUpgradeCosts[type];
            if (gameState.temporalShards >= cost) {
                gameState.temporalShards -= cost;
                switch (type) {
                    case 'globalKnowledgeBonus': gameState.epochShiftUpgrades.globalKnowledgeBonus += 0.01; gameState.epochShiftUpgradeCosts.globalKnowledgeBonus = Math.ceil(gameState.epochShiftUpgradeCosts.globalKnowledgeBonus * 1.2 +1); break; 
                    case 'globalInfluenceBonus': gameState.epochShiftUpgrades.globalInfluenceBonus += 0.01; gameState.epochShiftUpgradeCosts.globalInfluenceBonus = Math.ceil(gameState.epochShiftUpgradeCosts.globalInfluenceBonus * 1.2 + 1); break; 
                    case 'globalProgressBonus': gameState.epochShiftUpgrades.globalProgressBonus += 0.02; gameState.epochShiftUpgradeCosts.globalProgressBonus = Math.ceil(gameState.epochShiftUpgradeCosts.globalProgressBonus * 1.3 + 1); break; 
                    case 'startingKnowledgeLevel': gameState.epochShiftUpgrades.startingKnowledgeLevel += 1; gameState.epochShiftUpgradeCosts.startingKnowledgeLevel = Math.ceil(gameState.epochShiftUpgradeCosts.startingKnowledgeLevel * 1.5 + 1); break;
                    case 'shardMultiplierLevel': gameState.epochShiftUpgrades.shardMultiplierLevel += 1; gameState.epochShiftUpgradeCosts.shardMultiplierLevel = Math.ceil(gameState.epochShiftUpgradeCosts.shardMultiplierLevel * 2 + 3); break;
                }
                displayMessage("‚ú® Temporal Upgrade Acquired! üí™", "var(--temporal-shard-color)");
                playSound('upgradeSound');
                updateAllUI();
            } else {
                displayMessage("Not enough Temporal Shards! üåÄüò•", "var(--error-color)");
            }
        }
        
        function renderEpochShiftUpgrades() { updateEpochShiftUI(); }

        function renderParadigms() {
            const paradigmsList = document.getElementById('paradigms-list');
            paradigmsList.innerHTML = ''; // Clear existing
            const currentEra = getCurrentEraDefinition();
            if (!currentEra) return;

            Object.keys(PARADIGMS_TEMPLATE).forEach(key => {
                const paradigm = PARADIGMS_TEMPLATE[key];
                 const paradigmState = gameState.paradigms[key]; // Get current level from gameState
                 if (!paradigmState) return;


                const unlockEraId = paradigm.unlockedAtEraId || ERA_DEFINITIONS.find(e => e.unlocksParadigms && e.unlocksParadigms.includes(paradigm.id))?.id;
                const requiredEraOrder = ERA_DEFINITIONS.find(e => e.id === unlockEraId)?.epochShiftRequirementOrder || 999;
                
                if (currentEra.epochShiftRequirementOrder >= requiredEraOrder) {
                    const button = document.createElement('button');
                    button.id = paradigm.id;
                    button.classList.add('paradigm-button');
                    
                    let effectText = "";
                    if(key === 'scientificMethod') effectText = `+${(paradigmState.level * paradigm.effectPerLevel.knowledgeBonus * 100).toFixed(0)}% üí°, +${(paradigmState.level * paradigm.effectPerLevel.breakthroughChance * 100).toFixed(2)}% ‚ú® Chance`;
                    else if(key === 'industrialization') effectText = `+${(paradigmState.level * paradigm.effectPerLevel.passiveProgressRateBonus * 100).toFixed(0)}% üìà Mom., +${(paradigmState.level * paradigm.effectPerLevel.knowledgeFromDevelopments * 100).toFixed(0)}% üí° from Dev.`;
                    else if(key === 'informationAge' && paradigm.effectPerLevel) effectText = `+${(paradigmState.level * paradigm.effectPerLevel.allResourceBonus * 100).toFixed(0)}% All Gains`;


                    const costResource = paradigm.baseCostResource === "knowledge" ? "üí°" : "üåç";
                    const cost = Math.ceil(paradigm.baseCost * Math.pow(paradigm.costMultiplier, paradigmState.level) * (1 + (getCurrentEraDefinition()?.epochShiftRequirementOrder || 0) * 0.2));
                    button.innerHTML = `${paradigm.name} Lvl ${paradigmState.level}/${paradigm.maxLevel} <small>(Cost: ${cost}${costResource} | ${effectText})</small>`;
                    button.disabled = paradigmState.level >= paradigm.maxLevel;
                    button.addEventListener('click', () => buyParadigm(key));
                    paradigmsList.appendChild(button);
                }
            });
        }
        function buyParadigm(key) {
            const paradigmDef = PARADIGMS_TEMPLATE[key];
            const paradigmState = gameState.paradigms[key];

            if (paradigmState.level >= paradigmDef.maxLevel) {
                displayMessage(`${paradigmDef.name} is at maximum development! üöÄ`, "var(--info-color)"); return;
            }
            const cost = Math.ceil(paradigmDef.baseCost * Math.pow(paradigmDef.costMultiplier, paradigmState.level) * (1 + (getCurrentEraDefinition()?.epochShiftRequirementOrder || 0) * 0.2));
            let canAfford = false;
            if (paradigmDef.baseCostResource === "knowledge" && gameState.knowledge >= cost) {
                gameState.knowledge -= cost;
                canAfford = true;
            } else if (paradigmDef.baseCostResource === "influence" && gameState.influence >= cost) {
                gameState.influence -= cost;
                canAfford = true;
            }

            if (canAfford) {
                paradigmState.level++;
                displayMessage(`${paradigmDef.name} advanced to Lvl ${paradigmState.level}! ‚ú®`, "var(--success-color)");
                playSound('upgradeSound');
                updateAllUI(); // This will re-render paradigms
            } else {
                displayMessage(`Not enough ${paradigmDef.baseCostResource === "knowledge" ? "Knowledge üí°" : "Influence üåç"} for ${paradigmDef.name}! üò•`, "var(--error-color)");
            }
        }


        function checkDailyReward() {
            const now = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000;
            if (now - gameState.lastDailyRewardClaimed > twentyFourHours) {
                document.getElementById('daily-reward-popup').classList.add('visible');
                const currentEraOrder = getCurrentEraDefinition()?.epochShiftRequirementOrder || 0;
                const rewardKnowledge = 100 + currentEraOrder * 50 + gameState.epochShiftsPerformedTotal * 200 + gameState.epochShiftUpgrades.startingKnowledgeLevel * 50;
                const rewardInfluence = 50 + currentEraOrder * 20 + gameState.epochShiftsPerformedTotal * 100;
                document.getElementById('daily-reward-text').innerHTML = `Claim üí°${rewardKnowledge} Knowledge and üåç${rewardInfluence} Influence!`;
                playSound('popupOpen');
            }
        }
        function claimDailyReward() {
            const currentEraOrder = getCurrentEraDefinition()?.epochShiftRequirementOrder || 0;
            const rewardKnowledge = 100 + currentEraOrder * 50 + gameState.epochShiftsPerformedTotal * 200 + gameState.epochShiftUpgrades.startingKnowledgeLevel * 50;
            const rewardInfluence = 50 + currentEraOrder * 20 + gameState.epochShiftsPerformedTotal * 100;
            earnKnowledge(rewardKnowledge);
            earnInfluence(rewardInfluence); 
            gameState.lastDailyRewardClaimed = Date.now();
            document.getElementById('daily-reward-popup').classList.remove('visible');
            displayMessage(`üéÅ Temporal Echo: +üí°${rewardKnowledge}, +üåç${rewardInfluence}! üéâ`, "var(--influence-color)", 4000);
            playSound('rewardClaim');
            updateAllUI();
        }
        
        function calculateOfflineProgress() {
            const now = Date.now();
            const timeOfflineMs = now - (gameState.lastActiveTime || now);
            const maxOfflineTimeMs = 2 * 60 * 60 * 1000; 
            const effectiveOfflineTimeMs = Math.min(timeOfflineMs, maxOfflineTimeMs);
            const offlineSeconds = effectiveOfflineTimeMs / 1000;

            if (offlineSeconds > 60) { 
                const baseKnowledgePerSec = (gameState.passiveProgressRate * 0.03 + gameState.knowledgePerClick * 0.1); 
                const offlineKnowledgeRate = baseKnowledgePerSec * (1 + gameState.epochShiftUpgrades.globalKnowledgeBonus + gameState.knowledgeAffinityBonus + (gameState.paradigms.scientificMethod.level * gameState.paradigms.scientificMethod.effectPerLevel.knowledgeBonus)) * (1 + (gameState.paradigms.informationAge.level * (gameState.paradigms.informationAge.effectPerLevel?.allResourceBonus || 0)));
                const baseInfluencePerSec = (gameState.passiveProgressRate * 0.02); 
                const offlineInfluenceRate = baseInfluencePerSec * (1 + gameState.epochShiftUpgrades.globalInfluenceBonus + gameState.influenceSpreadBonus) * (1 + (gameState.paradigms.informationAge.level * (gameState.paradigms.informationAge.effectPerLevel?.allResourceBonus || 0)));   

                const knowledgeGained = Math.floor(offlineKnowledgeRate * offlineSeconds * 0.25); 
                const influenceGained = Math.floor(offlineInfluenceRate * offlineSeconds * 0.25);

                if (knowledgeGained > 0 || influenceGained > 0) {
                    earnKnowledge(knowledgeGained);
                    earnInfluence(influenceGained);
                    document.getElementById('offline-progress-text').innerHTML = `Your civilization gained üí°${knowledgeGained} Knowledge and üåç${influenceGained} Influence over ${formatTime(offlineSeconds)}!`;
                    document.getElementById('offline-progress-popup').classList.add('visible');
                    playSound('popupOpen');
                }
            }
            gameState.lastActiveTime = now; 
        }
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            let str = "";
            if (hours > 0) str += `${hours}h `;
            if (minutes > 0) str += `${minutes}m `;
            if (seconds > 0 || str === "") str += `${seconds}s`;
            return str.trim();
        }

        function tryStartGlobalEvent() {
            if (currentGlobalEvent || Math.random() > 0.33) return; 

            currentGlobalEvent = GLOBAL_EVENTS_TIMELINE[Math.floor(Math.random() * GLOBAL_EVENTS_TIMELINE.length)];
            globalEventTimer = currentGlobalEvent.duration;
            document.getElementById('global-event-display').textContent = currentGlobalEvent.message;
            document.getElementById('global-event-display').style.display = 'block';
            displayMessage(`üìú EVENT STARTED: ${currentGlobalEvent.name} üìú`, 'var(--info-color)', 5000);
            playSound('eventStart');
            updatePlayerStatsUI(); 
        }

        function endGlobalEvent() {
            if (!currentGlobalEvent) return;
            displayMessage(`üí® Event Ended: ${currentGlobalEvent.name}.`, 'var(--text-color)', 4000);
            currentGlobalEvent = null;
            globalEventTimer = 0;
            document.getElementById('global-event-display').style.display = 'none';
            playSound('eventEnd');
            updatePlayerStatsUI(); 
        }

        function passiveSave() {
            if (Date.now() - gameState.lastSaveTime > 28000) { 
                saveGame();
            }
        }
        function saveGame() {
            try {
                gameState.lastActiveTime = Date.now(); 
                localStorage.setItem('timelineClickerSave_v2', JSON.stringify(gameState)); 
                gameState.lastSaveTime = Date.now();
            } catch (e) {
                displayMessage("Error saving chronicle üò• (localStorage full/disabled).", "var(--error-color)");
            }
        }

        function loadGame() {
            let loadedStateJSON = null;
            const savedGame = localStorage.getItem('timelineClickerSave_v2'); 
            if (savedGame) {
                try {
                    loadedStateJSON = JSON.parse(savedGame);
                } catch (e) {
                    localStorage.removeItem('timelineClickerSave_v2'); 
                    console.error("Error parsing saved game: ", e);
                }
            }
            
            const defaultState = getDefaultGameState(); 
            let finalState = JSON.parse(JSON.stringify(defaultState)); 

            if (loadedStateJSON) {
                 // Merge top-level properties
                for (const key in defaultState) {
                    if (loadedStateJSON.hasOwnProperty(key)) {
                        if (typeof defaultState[key] === 'object' && defaultState[key] !== null && !Array.isArray(defaultState[key])) {
                            // Deep merge for objects like advancements, breakthroughs, paradigms etc.
                            finalState[key] = { ...defaultState[key], ...loadedStateJSON[key] };
                            // Ensure nested structures within these objects also get defaults if missing in save
                            if (key === "breakthroughs" || key === "paradigms") {
                                for (const subKey in defaultState[key]) {
                                    if (loadedStateJSON[key] && loadedStateJSON[key][subKey]) {
                                        finalState[key][subKey] = {...defaultState[key][subKey], ...loadedStateJSON[key][subKey]};
                                    } else {
                                        finalState[key][subKey] = {...defaultState[key][subKey]}; // ensure it exists
                                    }
                                }
                            }
                        } else {
                            finalState[key] = loadedStateJSON[key];
                        }
                    }
                }

                // Specific handling for milestones (preserving functions)
                finalState.milestones = MILESTONES_TEMPLATE.map(templateMs => {
                    const loadedMsData = loadedStateJSON.milestones?.find(lm => lm.id === templateMs.id);
                    return {
                        ...templateMs, // Includes condition function
                        reward: templateMs.reward ? JSON.parse(JSON.stringify(templateMs.reward)) : undefined,
                        permanentBonus: templateMs.permanentBonus ? JSON.parse(JSON.stringify(templateMs.permanentBonus)) : undefined,
                        claimed: loadedMsData ? loadedMsData.claimed : false 
                    };
                });
                
                // Ensure essential arrays exist
                finalState.completedDevelopmentIds = finalState.completedDevelopmentIds || [];
                finalState.completedEraIds = finalState.completedEraIds || [];
                finalState.temporaryBonuses = finalState.temporaryBonuses || { progressPerClick: 0, knowledgePerClick: 0, durationTicks: 0};


                 displayMessage("üíæ Chronicle Loaded Successfully! üéâ", "var(--success-color)");
            } else {
                 displayMessage("üåå No saved chronicle. A new timeline begins!", "var(--text-color)");
            }
            if(typeof finalState.lastActiveTime !== 'number') finalState.lastActiveTime = Date.now();
            return finalState;
        }

        function resetGame() {
            if (confirm("üõë ARE YOU SURE you want to shatter this timeline? ALL progress, including Epoch Shifts and Milestones, will be lost! This is permanent! üõë")) {
                localStorage.removeItem('timelineClickerSave_v2');
                gameState = getDefaultGameState();
                
                ['shift-knowledge-affinity', 'shift-influence-spread', 'epoch-shift-tab-button'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.style.display = 'none';
                });
                 Object.keys(PARADIGMS_TEMPLATE).forEach(pKey => {
                    const paradigmButton = document.getElementById(PARADIGMS_TEMPLATE[pKey].id);
                    if (paradigmButton) paradigmButton.style.display = 'none';
                });
                 const esButton = document.getElementById('epoch-shift-button');
                 if(esButton) esButton.disabled = true;

                openTab('gameTab'); 
                
                startNewEra(ERA_DEFINITIONS[0].id); 
                updateAllUI();
                renderMilestones();
                renderEpochShiftUpgrades();
                renderParadigms(); // Ensure paradigms are also cleared/hidden
                displayMessage("üîÑ Timeline Shattered! A fresh reality awaits! ‚ú®", "var(--error-color)", 5000);
                playSound('resetSound');
            }
        }

        window.onload = initGame;
    </script>
</body>
</html>
